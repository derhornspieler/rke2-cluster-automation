{{- $namePrefix := default .Release.Name .Values.vmNamePrefix -}}
{{- $namespace := .Values.namespaceOverride | default .Release.Namespace -}}
{{- $cloudConfig := printf "%s-cloud-config" (include "rke2-harvester.fullname" .) -}}
{{- $imageNamespace := .Values.image.namespace -}}
{{- $imageName := .Values.image.name -}}
{{- $imageID := printf "%s/%s" .Values.image.namespace .Values.image.name -}}
{{- $defaultSC := printf "longhorn-%s" .Values.image.name -}}
{{- $storageClass := .Values.storage.className | default $defaultSC -}}
{{- $accessMode := .Values.storage.accessMode -}}
{{- $volumeMode := .Values.storage.volumeMode -}}
{{- $cpDisk := .Values.storage.controlPlaneSize | default .Values.storage.size -}}
{{- $wkDisk := .Values.storage.workerSize | default .Values.storage.size -}}
{{- $vmNetwork := printf "%s/%s" .Values.networks.vm.namespace .Values.networks.vm.name -}}
{{- $cpMacs := .Values.networks.vm.macAddresses.controlPlane | default (list) -}}
{{- $wkMacs := .Values.networks.vm.macAddresses.worker | default (list) -}}
{{- $cpIPs := .Values.networks.vm.staticIPs.controlPlane | default (list) -}}
{{- $wkIPs := .Values.networks.vm.staticIPs.worker | default (list) -}}
{{- $prefix := int (default 24 .Values.networks.vm.prefix) -}}
{{- $gateway := .Values.networks.vm.gateway | default "" -}}
{{- $dns := .Values.networks.vm.nameservers | default (list) -}}
{{- $netInterface := .Values.networks.vm.interface | default "eth0" -}}
{{- $rancherNet := .Values.networks.rancher | default (dict) -}}
{{- $rancherNS := $rancherNet.namespace | default "" -}}
{{- $rancherName := $rancherNet.name | default "" -}}
{{- $rancherEnabled := and ($rancherNet.enabled | default false) (ne $rancherNS "") (ne $rancherName "") -}}
{{- $rancherNetwork := ternary (printf "%s/%s" $rancherNS $rancherName) "" $rancherEnabled -}}
{{- $rancherInterface := $rancherNet.interface | default "eth1" -}}
{{- $rancherPrefix := int (default 24 $rancherNet.prefix) -}}
{{- $rancherRoutes := $rancherNet.routes | default (list) -}}
{{- $rancherCpIPs := $rancherNet.staticIPs.controlPlane | default (list) -}}
{{- $rancherWkIPs := $rancherNet.staticIPs.worker | default (list) -}}
{{- $cpCPU := int (default 2 .Values.resources.controlPlane.cpuCores) -}}
{{- $cpHotplug := default false .Values.resources.controlPlane.enableHotplug -}}
{{- $cpMaxSockets := int (default $cpCPU .Values.resources.controlPlane.maxCpuSockets) -}}
{{- $cpMemMi := int (default 4096 .Values.resources.controlPlane.memoryMi) -}}
{{- $cpMem := printf "%dMi" $cpMemMi -}}
{{- $cpMemMax := printf "%dMi" (int (default $cpMemMi .Values.resources.controlPlane.maxMemoryMi)) -}}
{{- $cpCpuLimit := ternary $cpMaxSockets $cpCPU $cpHotplug -}}
{{- $cpMemLimit := ternary $cpMemMax $cpMem $cpHotplug -}}
{{- $wkCPU := int (default 2 .Values.resources.worker.cpuCores) -}}
{{- $wkHotplug := default false .Values.resources.worker.enableHotplug -}}
{{- $wkMaxSockets := int (default $wkCPU .Values.resources.worker.maxCpuSockets) -}}
{{- $wkMemMi := int (default 4096 .Values.resources.worker.memoryMi) -}}
{{- $wkMem := printf "%dMi" $wkMemMi -}}
{{- $wkMemMax := printf "%dMi" (int (default $wkMemMi .Values.resources.worker.maxMemoryMi)) -}}
{{- $wkCpuLimit := ternary $wkMaxSockets $wkCPU $wkHotplug -}}
{{- $wkMemLimit := ternary $wkMemMax $wkMem $wkHotplug -}}
{{- $cpCount := .Values.replicaCounts.controlPlane | int -}}
{{- $wkCount := .Values.replicaCounts.worker | int -}}

# ------------------------------------------------------------------
# Controlâ€‘plane VirtualMachines
# ------------------------------------------------------------------
{{- range $i := until $cpCount }}
{{- $vmOrdinal := add $i 1 -}}
{{- $vmName := printf "%s-cp-%d" $namePrefix $vmOrdinal -}}
{{- $pvcName := printf "%s-rootdisk" $vmName -}}
{{- $macAddr := include "rke2-harvester.macForIndex" (dict "list" $cpMacs "index" $i) -}}
{{- $staticIP := include "rke2-harvester.valueForIndex" (dict "list" $cpIPs "index" $i) -}}
{{- $rancherIP := include "rke2-harvester.valueForIndex" (dict "list" $rancherCpIPs "index" $i) -}}
{{- $rancherHasIP := and $rancherEnabled $rancherIP -}}
---
apiVersion: kubevirt.io/v1
kind: VirtualMachine
metadata:
  name: {{ $vmName }}
  namespace: {{ $namespace }}
  labels:
    app.kubernetes.io/name: {{ $namePrefix }}
    app.kubernetes.io/component: controlplane
    harvesterhci.io/vmName: {{ $vmName }}
  annotations:
    harvesterhci.io/volumeClaimTemplates: |-
{{ include "rke2-harvester.volumeClaimTemplates" (dict "pvcName" $pvcName "imageID" $imageID "storageClass" $storageClass "accessMode" $accessMode "volumeMode" $volumeMode "storageSize" $cpDisk) | indent 6 }}
{{- if $cpHotplug }}
    harvesterhci.io/enableCPUAndMemoryHotplug: "true"
{{- end }}
spec:
  runStrategy: Always
  template:
    metadata:
      labels:
        app.kubernetes.io/name: {{ $namePrefix }}
        app.kubernetes.io/component: controlplane
        harvesterhci.io/rke2-role: controlplane
        harvesterhci.io/vmName: {{ $vmName }}
    spec:
      hostname: {{ $vmName }}
      evictionStrategy: LiveMigrateIfPossible
      topologySpreadConstraints:
      - maxSkew: 1
        topologyKey: kubernetes.io/hostname
        whenUnsatisfiable: ScheduleAnyway
        labelSelector:
          matchLabels:
            app.kubernetes.io/name: {{ $namePrefix }}
            app.kubernetes.io/component: controlplane
      domain:
        cpu:
{{- if $cpHotplug }}
          sockets: {{ $cpCPU }}
          cores: 1
          threads: 1
          maxSockets: {{ $cpMaxSockets }}
{{- else }}
          cores: {{ $cpCPU }}
{{- end }}
        resources:
          limits:
            memory: {{ $cpMemLimit }}
            cpu: {{ $cpCpuLimit }}
          requests:
            memory: {{ $cpMem }}
            cpu: {{ $cpCPU }}
{{- if $cpHotplug }}
        memory:
          guest: {{ $cpMem }}
          maxGuest: {{ $cpMemMax }}
{{- end }}
        devices:
          autoattachPodInterface: false
          disks:
          - name: rootdisk
            bootOrder: 1
            disk:
              bus: virtio
          - name: cloudinitdisk
            disk:
              bus: virtio
          interfaces:
          - name: primary
            bridge: {}
            model: virtio
{{- if $macAddr }}
            macAddress: {{ $macAddr }}
{{- end }}
{{- if $rancherEnabled }}
          - name: rancher
            bridge: {}
            model: virtio
{{- end }}
      networks:
      - name: primary
        multus:
          networkName: {{ $vmNetwork }}
{{- if $rancherEnabled }}
      - name: rancher
        multus:
          networkName: {{ $rancherNetwork }}
{{- end }}
      volumes:
      - name: rootdisk
        persistentVolumeClaim:
          claimName: {{ $pvcName }}
      - name: cloudinitdisk
        cloudInitNoCloud:
          secretRef:
            name: {{ $cloudConfig }}
{{- if or $staticIP $rancherHasIP }}
          networkData: |
{{- $secondary := dict -}}
{{- if $rancherHasIP }}
{{- $_ := set $secondary "address" $rancherIP -}}
{{- $_ := set $secondary "prefix" $rancherPrefix -}}
{{- $_ := set $secondary "interface" $rancherInterface -}}
{{- $_ := set $secondary "routes" $rancherRoutes -}}
{{- end }}
{{ include "rke2-harvester.networkData" (dict "address" $staticIP "prefix" $prefix "gateway" $gateway "dns" $dns "interface" $netInterface "secondary" $secondary) | indent 12 }}
{{- end }}
{{ end }}

# ------------------------------------------------------------------
# Worker VirtualMachines
# ------------------------------------------------------------------
{{- range $i := until $wkCount }}
{{- $vmOrdinal := add $i 1 -}}
{{- $vmName := printf "%s-wk-%d" $namePrefix $vmOrdinal -}}
{{- $pvcName := printf "%s-rootdisk" $vmName -}}
{{- $macAddr := include "rke2-harvester.macForIndex" (dict "list" $wkMacs "index" $i) -}}
{{- $staticIP := include "rke2-harvester.valueForIndex" (dict "list" $wkIPs "index" $i) -}}
{{- $rancherIP := include "rke2-harvester.valueForIndex" (dict "list" $rancherWkIPs "index" $i) -}}
{{- $rancherHasIP := and $rancherEnabled $rancherIP -}}
---
apiVersion: kubevirt.io/v1
kind: VirtualMachine
metadata:
  name: {{ $vmName }}
  namespace: {{ $namespace }}
  labels:
    app.kubernetes.io/name: {{ $namePrefix }}
    app.kubernetes.io/component: worker
    harvesterhci.io/vmName: {{ $vmName }}
  annotations:
    harvesterhci.io/volumeClaimTemplates: |-
{{ include "rke2-harvester.volumeClaimTemplates" (dict "pvcName" $pvcName "imageID" $imageID "storageClass" $storageClass "accessMode" $accessMode "volumeMode" $volumeMode "storageSize" $wkDisk) | indent 6 }}
{{- if $wkHotplug }}
    harvesterhci.io/enableCPUAndMemoryHotplug: "true"
{{- end }}
spec:
  runStrategy: Always
  template:
    metadata:
      labels:
        app.kubernetes.io/name: {{ $namePrefix }}
        app.kubernetes.io/component: worker
        harvesterhci.io/rke2-role: worker
        harvesterhci.io/vmName: {{ $vmName }}
    spec:
      hostname: {{ $vmName }}
      evictionStrategy: LiveMigrateIfPossible
      topologySpreadConstraints:
      - maxSkew: 1
        topologyKey: kubernetes.io/hostname
        whenUnsatisfiable: ScheduleAnyway
        labelSelector:
          matchLabels:
            app.kubernetes.io/name: {{ $namePrefix }}
            app.kubernetes.io/component: worker
      domain:
        cpu:
{{- if $wkHotplug }}
          sockets: {{ $wkCPU }}
          cores: 1
          threads: 1
          maxSockets: {{ $wkMaxSockets }}
{{- else }}
          cores: {{ $wkCPU }}
{{- end }}
        resources:
          limits:
            memory: {{ $wkMemLimit }}
            cpu: {{ $wkCpuLimit }}
          requests:
            memory: {{ $wkMem }}
            cpu: {{ $wkCPU }}
{{- if $wkHotplug }}
        memory:
          guest: {{ $wkMem }}
          maxGuest: {{ $wkMemMax }}
{{- end }}
        devices:
          autoattachPodInterface: false
          disks:
          - name: rootdisk
            bootOrder: 1
            disk:
              bus: virtio
          - name: cloudinitdisk
            disk:
              bus: virtio
          interfaces:
          - name: primary
            bridge: {}
            model: virtio
{{- if $macAddr }}
            macAddress: {{ $macAddr }}
{{- end }}
{{- if $rancherEnabled }}
          - name: rancher
            bridge: {}
            model: virtio
{{- end }}
      networks:
      - name: primary
        multus:
          networkName: {{ $vmNetwork }}
{{- if $rancherEnabled }}
      - name: rancher
        multus:
          networkName: {{ $rancherNetwork }}
{{- end }}
      volumes:
      - name: rootdisk
        persistentVolumeClaim:
          claimName: {{ $pvcName }}
      - name: cloudinitdisk
        cloudInitNoCloud:
          secretRef:
            name: {{ $cloudConfig }}
{{- if or $staticIP $rancherHasIP }}
          networkData: |
{{- $secondary := dict -}}
{{- if $rancherHasIP }}
{{- $_ := set $secondary "address" $rancherIP -}}
{{- $_ := set $secondary "prefix" $rancherPrefix -}}
{{- $_ := set $secondary "interface" $rancherInterface -}}
{{- $_ := set $secondary "routes" $rancherRoutes -}}
{{- end }}
{{ include "rke2-harvester.networkData" (dict "address" $staticIP "prefix" $prefix "gateway" $gateway "dns" $dns "interface" $netInterface "secondary" $secondary) | indent 12 }}
{{- end }}
{{ end }}
